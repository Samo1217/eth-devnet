---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: geth-devnet
  namespace: {{.Release.Namespace}}
  labels:
    app.kubernetes.io/name: geth-devnet
spec:
  replicas: {{.Values.replicaCount}}
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: geth-devnet
  template:
    metadata:
      labels:
        app.kubernetes.io/name: geth-devnet
    spec:
      containers:
        - name: geth
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{.Values.image.pullPolicy}}
          args:
            - "--dev"
            - "--dev.period={{ .Values.devPeriodSeconds }}"
            - "--datadir={{ .Values.datadir.path }}"
            - "--http"
            - "--http.addr=0.0.0.0"
            - "--http.port={{ .Values.service.rpcPort }}"
            - "--http.api=eth,net,web3,txpool,debug,personal"
            - "--http.corsdomain=*"
            - "--http.vhosts=*"
            - "--ws"
            - "--ws.addr=0.0.0.0"
            - "--ws.port={{ .Values.service.wsPort }}"
            - "--ipcdisable"
            - "--verbosity=3"
            - "--metrics"
            - "--metrics.addr=0.0.0.0"
            - "--metrics.port=6060"
          ports:
            - name: rpc
              containerPort: {{ .Values.service.rpcPort }}
            - name: ws
              containerPort: {{ .Values.service.wsPort }}
            - name: p2p
              containerPort: {{ .Values.service.p2pPort }}
            - name: metrics
              containerPort: 6060
          resources:
{{ toYaml .Values.resources | indent 12 }}
          volumeMounts:
            - name: geth-data
              mountPath: {{ .Values.datadir.path }}
      volumes:
        - name: geth-data
          persistentVolumeClaim:
            claimName: {{ .Values.datadir.pvc.name }}
